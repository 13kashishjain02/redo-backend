{% load static %}
{% load mathfilters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redopact | Cart</title>

    <link rel="stylesheet" href="{% static 'general/css/bootstrap.css'%}">

    <!-- Our project just needs Font Awesome Free's Solid + Brand files -->
    <link href="{% static 'fontawesomefree/css/fontawesome.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'fontawesomefree/css/brands.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'fontawesomefree/css/solid.css' %}" rel="stylesheet" type="text/css">


    <style>
        .nav-panel .nav-header{
                display: flex;
                align-items: center;
                justify-content: space-between;
        }

        .cart .cart-item{
            display: flex;
            justify-content: space-between;
        }

        .cart .cart-item .items{
            display: flex;
            align-items:flex-start;
        }


        .cart .bill .coupon , .mrp , .c-discount, .d-charge, .t-bill{
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>

</head>
<body>

    <div class="container-fluid nav-panel">

        <div class="nav-header container py-3">

            <div class="logo">
                <a href="/"><img src="{% static 'general/images/Redopact.png' %}" width="150px" alt="logo"></a>
            </div>

            <div class="position">
                <h5 style="font-size: 13px;color: #7B7D89;"><span class="" style="border-bottom: 2px solid #20BD99;color: #20BD99;">CART</span> --------- ADDRESS --------- Payment</h5>
            </div>

            <div class="secure">
              <img src="{% static 'general/images/sprite-secure.png'%}" width="30px" alt=""> <span style="color: #5C606E;font-size: 13px;">100% SECURE</span>
            </div>

        </div>

    </div>


    <div class="container mt-5">
        <ol class="breadcrumb px-3">
            <li class="breadcrumb-item"><a href="/" style="text-decoration: none;">Home</a></li>
            <li class="breadcrumb-item active">Cart</li>
          </ol>
      
          <h4 class="mt-5 px-3"><span class="text-primary">My cart -</span> {{products.count|addition:products_v.count}} Items</h4>
    </div>


    {% if messages %}
    {% for message in messages %}
      <div class="container alert alert-{{message.tags}}">
        {{message}}
      </div>
    {% endfor %}
  {% endif %}


    {% if products or products_v %}
    
    <div class="cart container my-5">
        <div class="row">


           
            <div class="col-sm-12 col-md-12 col-lg-8 mt-2">
                <div class="row">
                {% for product in products %}
                    <div class="col-sm-12 col-md-12 col-lg-12 mt-2">
                        <div class="cart-item border p-3">
                        
                            <div class="items">
                            <a href="/{{product.product.id}}/buy/"><img src="{{product.product.image.url}}" class="img-fluid" style="width: 150px;" alt=""></a>
                            <div class="items-details p-3">
                                <span style="color: black;">{{product.product.brand}}</span><br>
                                <span style="font-weight: 200;">{{product.product.name}}</span><br>
                                <span style="font-size: 13px;color: #BEC0C5;">Sold by : {{product.product.vendor}}</span> <br><br>
                                <h5 id="product-price{{product.id}}">Rs. {{product.product.special_price|mul:product.quantity}}</h5>
                                <label for="">Quantity</label>
                                <select class="form-select bg-white" id="change-quantity{{product.id}}" style="border: 2px solid #1A4953;width: 8rem;" id="exampleSelect1">
                                    <option value="1" {% if product.quantity == 1 %} selected {% endif %}>1</option>
                                    <option value="2" {% if product.quantity == 2 %} selected {% endif %}>2</option>
                                    <option value="3" {% if product.quantity == 3 %} selected {% endif %}>3</option>
                                    <option value="4" {% if product.quantity == 4 %} selected {% endif %}>4</option>
                                    <option value="5" {% if product.quantity == 5 %} selected {% endif %}>5</option>
                                    <option value="6" {% if product.quantity == 6 %} selected {% endif %}>6</option>
                                    <option value="7" {% if product.quantity == 7 %} selected {% endif %}>7</option>
                                    <option value="8" {% if product.quantity == 8 %} selected {% endif %}>8</option>
                                    <option value="9" {% if product.quantity == 9 %} selected {% endif %}>9</option>
                                    <option value="10" {% if product.quantity == 10 %} selected {% endif %}>10</option>
                                </select> <br>
                                <br>
                                <h6><i class="fa-solid fa-check" style="color: #20BD99;"></i> Deliver by 24 Feb 2022</h6>
                            </div>  
                            </div> 
                        <form action="/remove-product/{{product.id}}/" method="post"> {%csrf_token%}
                            <button class="btn"><span class="px-3" style="font-size: 25px;"> <i class="fa-solid fa-xmark"></i></span></button>
                        </form>
                                
                        </div>
                    </div>
                {% endfor %}

                {% for product_v in products_v %}
                    <div class="col-sm-12 col-md-12 col-lg-12 mt-2">
                        <div class="cart-item border p-3">
                        
                            <div class="items">
                            <a href="/variation/{{product_v.product_variation.id}}/buy/?color={{product_v.product_variation.color}}"><img src="{{product_v.product_variation.image1.url}}" class="img-fluid" style="width: 150px;" alt=""></a>
                            <div class="items-details p-3">
                                <span style="color: black;">{{product_v.product_variation.product.brand}}</span><br>
                                <span style="font-weight: 200;">{{product_v.product_variation.product.name}}</span><br>
                                <span style="font-size: 13px;color: #BEC0C5;">Sold by : {{product_v.product_variation.product.vendor}}</span> <br><br>
                                <h5 id="product-price-variation{{product_v.id}}">Rs. {{product_v.product_variation.special_price|mul:product_v.quantity}}</h5>
                               
                                <label>Color</label><div class="border" style="border-radius: 50%;background-color: {{product_v.product_variation.color}};width:30px;height:30px;"></div><br>
                                <span>Size : {{product_v.size}}</span><br><br>
                                <label for="">Quantity</label><br><br>
                                <select class="form-select bg-white" id="change-quantity-variation{{product_v.product_variation.id}}" style="border: 2px solid #1A4953;width: 8rem;" id="exampleSelect1">
                                    <option value="1" {% if product_v.quantity == 1 %} selected {% endif %}>1</option>
                                    <option value="2" {% if product_v.quantity == 2 %} selected {% endif %}>2</option>
                                    <option value="3" {% if product_v.quantity == 3 %} selected {% endif %}>3</option>
                                    <option value="4" {% if product_v.quantity == 4 %} selected {% endif %}>4</option>
                                    <option value="5" {% if product_v.quantity == 5 %} selected {% endif %}>5</option>
                                    <option value="6" {% if product_v.quantity == 6 %} selected {% endif %}>6</option>
                                    <option value="7" {% if product_v.quantity == 7 %} selected {% endif %}>7</option>
                                    <option value="8" {% if product_v.quantity == 8 %} selected {% endif %}>8</option>
                                    <option value="9" {% if product_v.quantity == 9 %} selected {% endif %}>9</option>
                                    <option value="10" {% if product_v.quantity == 10 %} selected {% endif %}>10</option>
                                </select> <br>
                                <br>
                                <h6><i class="fa-solid fa-check" style="color: #20BD99;"></i> Deliver by 24 Feb 2022</h6>
                            </div>  
                            </div> 
                        <form action="/remove-product/{{product_v.id}}/" method="post"> {%csrf_token%}
                            <button class="btn"><span class="px-3" style="font-size: 25px;"> <i class="fa-solid fa-xmark"></i></span></button>
                        </form>
                                
                        </div>
                    </div>
                {% endfor %}
            </div>
            </div>

           


            <div class="col-sm-12 col-md-12 col-lg-4 mt-3">
                  <div class="bill border px-3 py-4">
                <h5 style="color:#7B7D89;font-size: 14px;">Coupons</h5> <br>
                <div class="coupon">
                    <h5 style="font-size: 13px;"><i class="fa-solid fa-tag"></i> Apply Coupon</h5>
                    <button class="btn btn-outline-primary py-1 mx-5" data-bs-toggle="modal" data-bs-target="#coupon" style="font-size: 12px;">Apply</button>
                </div>
                <hr>
                <h6>price details (item {{products.count}})</h6> <br>
                <div class="mrp">
                    <h5 style="font-size: 13px;color:#5C606E;">Total MRP</h5>
                    <h5 id="total-mrp" style="font-size: 13px;color:#20BD99;">₹ {{mrp}}</h5>
                </div>

                <div class="c-discount mt-2">
                    <h5 style="font-size: 13px;color:#5C606E;">Coupon Discount</h5>
                    <h5 style="font-size: 13px;color:#20BD99;">
                        {% if request.session.discount %}
                        ₹ {{request.session.discount}}
                        {% else %}
                        <a href="#" data-bs-toggle="modal" data-bs-target="#coupon" style="text-decoration: none;font-size: 14px;">Apply Coupon</a>
                        {% endif %}
                    </h5>
                </div>

                <div class="d-charge mt-2">
                    <h5 style="font-size: 13px;color:#5C606E;">Delivery Charge</h5>
                    <h5 style="font-size: 13px;color:#20BD99;">₹ 0</h5>
                </div>

                <hr>

                <div class="t-bill mt-2">
                    <h5 style="font-size: 13px;color:black;">Total Amount</h5>
                    <h5 id="total-amount" style="font-size: 13px;color:#20BD99;">₹ {{total_amount}}</h5>
                </div>

                <div class="mt-5 text-center">
                    <a href="/checkout/address/" class="btn bg-primary text-white px-5 shadow" style="border-radius: 4px;">Place Order</a>
                </div>

            </div>
            </div>
        </div>
    </div>

    {% else %}

    <div class="text-center mt-5 pt-5">
        <h5>Hey its feels so light!</h5> 
        <span>There is nothing in your bag. Let's add some items</span><br><br>
        <a href="/wishlist/" class="btn bg-primary text-white px-5 shadow-sm">Add items from wishlist</a>
    </div>

    {% endif %}


    <div class="modal fade" id="coupon" tabindex="-1" aria-labelledby="couponLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="couponLabel">Apply Coupon</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
                <div class="modal-body">
                    <input type="text" name="coupon" id="coupon-code" placeholder="Enter coupon code" class="form-control">
                    <label style="font-size:13px" class="text-danger" id="coupon-msg"></label>

                    {% if request.session.coupon_code and request.session.discount %}
                        <div class="mt-2 p-2" style="display: inline-block;border: 1px dashed red;">
                           <p style="font-size: 14px;display: inline;">{{request.session.coupon_code}}</p>
                        </div>
                        <br>
                        <p class="p-2" style="font-size: 14px;display: inline;color: black;">Save ₹{{request.session.discount}}</p> <br>
                        <small class="text-danger px-2" id="removeCoupon" style="cursor: pointer;">remove</small>
                    {% endif %}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" id="applyCoupon" class="btn bg-primary text-white">Apply</button>
                </div>
          </div>
        </div>
      </div>



<!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    

{% for product in products %}

<script>
    var total_mrp = document.getElementById('total-mrp')
    var total_amount = document.getElementById('total-amount')
    var change_quantity{{product.id}} = document.getElementById('change-quantity{{product.id}}')
    var product_price{{product.id}} = document.getElementById('product-price{{product.id}}')
    change_quantity{{product.id}}.addEventListener('change',()=>{
            var quantity{{product.id}} =  change_quantity{{product.id}}.options[change_quantity{{product.id}}.selectedIndex].text;
            $.ajax({
                type: 'POST',
                url: "/change-quantity/{{product.id}}/",
                data:{
                    quantity: quantity{{product.id}},
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    product_price{{product.id}}.innerHTML = `Rs. ${response.price}`
                    total_mrp.innerHTML = `₹ ${response.total_mrp}`
                    total_amount.innerHTML = `₹ ${response.total_amount}`
                }
            })
    })
    
</script>
{% endfor %}

<script>
    {% for product_v in products_v %}
        var total_mrp = document.getElementById('total-mrp')
        var total_amount = document.getElementById('total-amount')
        var change_quantity_variation{{product_v.product_variation.id}} = document.getElementById('change-quantity-variation{{product_v.product_variation.id}}')
        var product_price_variation{{product_v.id}} = document.getElementById('product-price-variation{{product_v.id}}')
        change_quantity_variation{{product_v.product_variation.id}}.addEventListener('change',()=>{
            var quantity{{product_v.id}} =  change_quantity_variation{{product_v.product_variation.id}}.options[change_quantity_variation{{product_v.product_variation.id}}.selectedIndex].text;
            $.ajax({
                type: 'POST',
                url: "/change-quantity-variation/{{product_v.id}}/",
                data:{
                    quantity: quantity{{product_v.id}},
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    product_price_variation{{product_v.id}}.innerHTML = `Rs. ${response.price}`
                    total_mrp.innerHTML = `₹ ${response.total_mrp}`
                    total_amount.innerHTML = `₹ ${response.total_amount}`
                }
            })
        })
    {% endfor %}


    $('#applyCoupon').click(()=>{

        coupon_code = $('#coupon-code').val()
        $.ajax({
                type: 'POST',
                url: "/apply-coupon/",
                data:{
                    coupon: coupon_code,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.invalid) {
                        $('#coupon-msg').text(response.invalid)
                    }
                    else if(response.success){
                        total_mrp.innerHTML = `₹ ${response.total_mrp}`
                        total_amount.innerHTML = `₹ ${response.total_amount}`
                        window.location.href = "/checkout/cart/";
                    }
                    

                }
            })
       
    })


    $('#removeCoupon').click(()=>{
    $.ajax({
            type: 'POST',
            url: "/remove-coupon/",
            data:{
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (response) {
                    total_mrp.innerHTML = `₹ ${response.total_mrp}`
                    total_amount.innerHTML = `₹ ${response.total_amount}`
                    window.location.href = "/checkout/cart/";
            }
    })

})




</script>


</body>
</html>
